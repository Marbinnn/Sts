<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>STS Trivia</title>
  <style>
    :root{
      --bg:#0b0b0f;
      --line:#2b2b3a;
      --text:#f5f5ff;
      --muted:#b9b9d6;
      --good:#4ade80;
      --bad:#fb7185;
      --accent:#7c3aed;
      --accent2:#22c55e;
      --warn:#fbbf24;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --r:22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sys: -apple-system, BlinkMacSystemFont, "SF Pro Display","SF Pro Text", system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sys);
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(124,58,237,.22), transparent 55%),
        radial-gradient(900px 700px at 80% 0%, rgba(34,197,94,.14), transparent 60%),
        radial-gradient(1200px 900px at 40% 100%, rgba(251,191,36,.10), transparent 60%),
        var(--bg);
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:22px;
    }

    .app{
      width:min(980px, 100%);
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:16px;
    }
    @media (max-width: 900px){ .app{grid-template-columns:1fr} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.0));
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .head{
      padding:16px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.02);
      gap:12px;
    }
    .title{
      display:flex;
      gap:10px;
      align-items:center;
      font-weight:900;
      letter-spacing:.3px;
      font-size:16px;
      flex:1;
      min-width:0;
    }
    .title span.txt{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background: var(--accent);
      box-shadow: 0 0 0 3px rgba(124,58,237,.22);
      flex:0 0 auto;
    }
    .pill{
      font-family:var(--mono);
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding:6px 10px;
      border-radius:999px;
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }

    .main{
      padding:18px;
      background: linear-gradient(180deg, rgba(20,20,27,.85), rgba(20,20,27,.55));
    }

    .qmeta{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin-bottom:12px;
    }
    .chip{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding:6px 10px;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .chip strong{color:var(--text)}

    .progress{
      height:10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      overflow:hidden;
      flex:1;
      min-width:160px;
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--accent), #60a5fa, var(--accent2));
      border-radius:999px;
      transition: width .35s ease;
    }

    /* Timer bar (shrinks) */
    .timerWrap{
      width:100%;
      height:10px;
      border-radius:999px;
      border:1px solid rgba(251,191,36,.45);
      background: rgba(255,255,255,.03);
      overflow:hidden;
      margin:10px 0 6px;
      position:relative;
    }
    .timerBar{
      height:100%;
      width:100%;
      background: linear-gradient(90deg, rgba(251,191,36,.95), rgba(251,113,133,.95));
      border-radius:999px;
      transform-origin:left center;
      transform:scaleX(1);
    }
    .timerHint{
      font-size:12px;
      color:var(--muted);
      margin:0 0 10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      user-select:none;
    }
    .timerHint span{
      font-family:var(--mono);
      opacity:.9;
    }

    .question{
      font-size:20px;
      font-weight:900;
      line-height:1.25;
      margin:6px 0 14px;
      letter-spacing:.2px;
    }
    .sub{
      color:var(--muted);
      margin:0 0 12px;
      font-size:13px;
      line-height:1.5;
    }

    .choices{
      display:grid;
      gap:10px;
      margin-top:10px;
    }
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      padding:12px 12px;
      border-radius:16px;
      cursor:pointer;
      text-align:left;
      display:flex;
      gap:12px;
      align-items:flex-start;
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.05);}
    .btn:active{transform: translateY(0px);}
    .btn[disabled]{opacity:.70; cursor:not-allowed; transform:none}
    .key{
      width:28px;height:28px;border-radius:10px;
      display:grid;place-items:center;
      font-family:var(--mono);
      font-size:12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.25);
      color:var(--muted);
      flex:0 0 auto;
    }
    .choiceText{font-size:14px; line-height:1.4}

    .btn.good{
      border-color: rgba(74,222,128,.55);
      background: rgba(74,222,128,.08);
    }
    .btn.bad{
      border-color: rgba(251,113,133,.55);
      background: rgba(251,113,133,.08);
    }

    .feedback{
      margin-top:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      border-radius:16px;
      padding:12px 12px;
      display:none;
    }
    .feedback.show{display:block}

    .fbRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .badge{
      font-family:var(--mono);
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .badge.good{border-color: rgba(74,222,128,.55); color:#c7f9d7; background: rgba(74,222,128,.08);}
    .badge.bad{border-color: rgba(251,113,133,.55); color:#ffd0d8; background: rgba(251,113,133,.08);}
    .badge.warn{border-color: rgba(251,191,36,.55); color:#ffe9b6; background: rgba(251,191,36,.10);}

    .explain{
      color:var(--muted);
      font-size:13px;
      line-height:1.55;
      margin-top:10px;
    }

    .controls{
      display:flex;
      gap:10px;
      margin-top:12px;
      flex-wrap:wrap;
    }
    .mini{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      cursor:pointer;
      transition: background .2s ease, transform .06s ease, border-color .2s ease;
      font-weight:800;
    }
    .mini:hover{background: rgba(255,255,255,.05); transform: translateY(-1px);}
    .mini:active{transform: translateY(0px);}
    .mini.primary{ border-color: rgba(124,58,237,.6); background: rgba(124,58,237,.14); }
    .mini.good{ border-color: rgba(34,197,94,.6); background: rgba(34,197,94,.12); }

    /* Side panel */
    .side{ display:flex; flex-direction:column; height:100%; }
    .side .main{padding:16px;}
    .statGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-bottom:12px;
    }
    .stat{
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px 12px;
      background: rgba(255,255,255,.02);
    }
    .stat .k{color:var(--muted); font-size:12px}
    .stat .v{font-size:20px; font-weight:900; margin-top:6px}
    .stat .v small{font-size:12px; color:var(--muted); font-weight:700}

    .list{
      margin-top:10px;
      border:1px solid var(--line);
      border-radius:18px;
      background: rgba(255,255,255,.02);
      overflow:hidden;
    }
    .listHead{
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .listHead .k{color:var(--muted); font-size:12px}
    .items{ max-height: 260px; overflow:auto; }
    .item{
      padding:10px 12px;
      border-top:1px solid rgba(43,43,58,.65);
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .item:first-child{border-top:none}
    .tag{
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted);
      border:1px solid var(--line);
      padding:4px 8px;
      border-radius:999px;
      background: rgba(0,0,0,.25);
      flex:0 0 auto;
      margin-top:2px;
    }
    .item .txt{
      font-size:13px;
      line-height:1.35;
      color:var(--text);
    }
    .item .txt em{
      color:var(--muted);
      font-style:normal;
      display:block;
      margin-top:4px;
      font-size:12px;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:20px;
      transform:translateX(-50%);
      background: rgba(20,20,27,.9);
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      padding:10px 12px;
      border-radius:999px;
      color:var(--text);
      font-size:13px;
      display:none;
      gap:10px;
      align-items:center;
      z-index:50;
      max-width:min(92vw, 520px);
    }
    .toast.show{display:flex}
    .toast .b{
      width:10px;height:10px;border-radius:999px;background: var(--accent2);
      box-shadow:0 0 0 3px rgba(34,197,94,.18);
      flex:0 0 auto;
    }

    .footerNote{
      margin-top:12px;
      color:var(--muted);
      font-size:12px;
      line-height:1.45;
    }
  </style>
</head>
<body>
  <div class="app">

    <!-- Main Quiz -->
    <section class="card">
      <div class="head">
        <div class="title">
          <span class="dot"></span>
          <span class="txt">STS Trivia ‚Äî Historical Development + PH + Ethics</span>
        </div>
        <div class="pill"><span>Mode:</span> <strong id="modeLabel">Mixed</strong></div>
      </div>

      <div class="main">
        <div class="qmeta">
          <div class="chip">Question <strong id="qNum">1</strong>/<span id="qTotal">‚Äî</span></div>
          <div class="chip">Difficulty: <strong id="qDiff">‚Äî</strong></div>
          <div class="chip">Streak: <strong id="streak">0</strong></div>
          <div class="progress"><div class="bar" id="bar"></div></div>
        </div>

        <!-- Shrinking timer bar -->
        <div class="timerWrap" id="timerWrap" style="display:none;">
          <div class="timerBar" id="timerBar"></div>
        </div>
        <div class="timerHint" id="timerHint" style="display:none;">
          <span>15s</span>
          <span>think fast üíÄ</span>
        </div>

        <div class="question" id="questionText">Press Start.</div>
        <p class="sub" id="questionSub">You got 15 seconds each question. One correct answer only.</p>

        <div class="choices" id="choices"></div>

        <div class="feedback" id="feedback">
          <div class="fbRow">
            <span class="badge" id="resultBadge">‚Äî</span>
            <span class="badge" id="answerBadge">‚Äî</span>
          </div>
          <div class="explain" id="explain"></div>

          <div class="controls">
            <button class="mini good" id="exportBtn">Export Result Card</button>
          </div>
        </div>

        <div class="controls" id="startControls">
          <button class="mini primary" id="startBtn">Start</button>
        </div>

        <div class="footerNote">
          Keyboard: <span style="font-family:var(--mono)">A B C D</span> ¬∑ Auto-next after answer/timeout.
        </div>
      </div>
    </section>

    <!-- Side Panel -->
    <aside class="card side">
      <div class="head">
        <div class="title">
          <span class="dot" style="background:var(--accent2); box-shadow:0 0 0 3px rgba(34,197,94,.18)"></span>
          <span class="txt">Your Run</span>
        </div>
        <div class="pill"><span>Score</span> <strong id="scorePill">0</strong></div>
      </div>

      <div class="main">
        <div class="statGrid">
          <div class="stat"><div class="k">Correct</div><div class="v" id="correctStat">0</div></div>
          <div class="stat"><div class="k">Wrong</div><div class="v" id="wrongStat">0</div></div>
          <div class="stat"><div class="k">Accuracy</div><div class="v" id="accStat">0<small>%</small></div></div>
          <div class="stat"><div class="k">Answered</div><div class="v" id="answeredStat">0</div></div>
        </div>

        <div class="list">
          <div class="listHead">
            <div class="k">Wrong answers log</div>
            <div class="badge" id="wrongCountBadge">0 wrong</div>
          </div>
          <div class="items" id="wrongList"></div>
        </div>

        <div class="footerNote">
          Timer: 15 seconds bar. If time runs out, it counts wrong.
        </div>
      </div>
    </aside>
  </div>

  <div class="toast" id="toast"><span class="b"></span><span id="toastTxt">Nice.</span></div>

<script>
(() => {
  // ===== Questions (only 1 correct each) =====
  const QUESTIONS = [
    { q:"What does STS stand for?",
      choices:["Science, Technology, and Society","Social Technology Systems","Science and Technical Systems","Systems, Tools, and Software"],
      a:0, diff:"Easy", topic:"STS",
      explain:"STS looks at how science/technology affect society and how society shapes them."
    },
    { q:"Science is mainly the‚Ä¶",
      choices:["application of knowledge to build tools","systematic study of the natural world through observation and experimentation","set of laws made by government","art of creating machines only"],
      a:1, diff:"Easy", topic:"Science",
      explain:"Science focuses on observing, testing, and explaining natural phenomena."
    },
    { q:"Technology is best described as‚Ä¶",
      choices:["only computers and phones","a political system","application of scientific knowledge to create tools/processes that improve life","the same as science"],
      a:2, diff:"Easy", topic:"Technology",
      explain:"Technology applies knowledge to solve problems using tools and systems."
    },
    { q:"In STS, science and technology are considered‚Ä¶",
      choices:["unrelated","interdependent","enemies of society","only school subjects"],
      a:1, diff:"Easy", topic:"STS",
      explain:"They influence each other: discoveries enable new tech, and tech enables discoveries."
    },
    { q:"Which invention enabled record-keeping and knowledge transfer in early civilizations?",
      choices:["Wheel","Cuneiform and Hieroglyphics","DNA model","Smartphone"],
      a:1, diff:"Easy", topic:"History",
      explain:"Early writing systems stored information beyond memory."
    },
    { q:"Roman Aqueducts were engineered mainly to‚Ä¶",
      choices:["carry water to cities","create electricity","build phones","edit genes"],
      a:0, diff:"Easy", topic:"History",
      explain:"Aqueducts delivered water for public and daily use."
    },
    { q:"Gutenberg‚Äôs Printing Press (c. 1440) enabled‚Ä¶",
      choices:["mass production of written materials","instant messaging","genetic editing","flight"],
      a:0, diff:"Easy", topic:"History",
      explain:"It spread knowledge faster by producing books/materials in large amounts."
    },
    { q:"Francis Bacon is linked to promoting the‚Ä¶",
      choices:["scientific method","steam engine","roman aqueduct","blockchain"],
      a:0, diff:"Medium", topic:"Scientific Revolution",
      explain:"He emphasized observation and experimentation as a system."
    },
    { q:"James Watt‚Äôs steam engine mainly boosted‚Ä¶",
      choices:["mechanized production and productivity","ancient trade only","DNA research","writing systems"],
      a:0, diff:"Medium", topic:"Industrial Revolution",
      explain:"Steam power drove factories and machines."
    },
    { q:"Fleming‚Äôs penicillin (1928) was the first‚Ä¶",
      choices:["effective antibiotic","printing press","smartphone OS","gene editor"],
      a:0, diff:"Easy", topic:"20th Century",
      explain:"It fought bacterial infections and changed medicine."
    },
    { q:"CRISPR-Cas9 (2012) enables‚Ä¶",
      choices:["precise gene editing","roman water delivery","mass book printing","mechanical timekeeping"],
      a:0, diff:"Medium", topic:"21st Century",
      explain:"CRISPR allows targeted changes to DNA."
    },
    { q:"Banaue Rice Terraces are best described as‚Ä¶",
      choices:["an engineering marvel for sustainable farming/irrigation","a modern phone invention","a roman aqueduct","a gene tool"],
      a:0, diff:"Easy", topic:"Philippines",
      explain:"They show advanced indigenous engineering in mountain farming."
    },
    { q:"Respect for people in research includes‚Ä¶",
      choices:["obtaining informed consent and protecting privacy","sharing private info publicly","testing without permission","taking data without consent"],
      a:0, diff:"Easy", topic:"Ethics",
      explain:"Ethics requires consent and privacy protection."
    },
    { q:"Accountability and fair access means‚Ä¶",
      choices:["taking responsibility for consequences and ensuring equitable access","only rich people get tech","never admitting mistakes","hiding risks"],
      a:0, diff:"Hard", topic:"Ethics",
      explain:"It‚Äôs about owning outcomes and reducing inequality in access."
    },
  ];

  // ===== State =====
  const TIME_MS = 15000; // 15 seconds
  let pool = [];
  let idx = 0;
  let locked = false;

  let score = 0;
  let correct = 0;
  let wrong = 0;
  let streak = 0;
  let answered = 0;

  const wrongLog = [];

  // Timer animation
  let raf = null;
  let tStart = 0;
  let tEnd = 0;

  // ===== DOM =====
  const qNumEl = document.getElementById("qNum");
  const qTotalEl = document.getElementById("qTotal");
  const qDiffEl = document.getElementById("qDiff");
  const streakEl = document.getElementById("streak");
  const barEl = document.getElementById("bar");

  const timerWrap = document.getElementById("timerWrap");
  const timerBar = document.getElementById("timerBar");
  const timerHint = document.getElementById("timerHint");

  const questionTextEl = document.getElementById("questionText");
  const questionSubEl = document.getElementById("questionSub");
  const choicesEl = document.getElementById("choices");

  const feedbackEl = document.getElementById("feedback");
  const resultBadgeEl = document.getElementById("resultBadge");
  const answerBadgeEl = document.getElementById("answerBadge");
  const explainEl = document.getElementById("explain");

  const startControlsEl = document.getElementById("startControls");
  const startBtn = document.getElementById("startBtn");
  const exportBtn = document.getElementById("exportBtn");

  const modeLabel = document.getElementById("modeLabel");
  const scorePill = document.getElementById("scorePill");
  const correctStat = document.getElementById("correctStat");
  const wrongStat = document.getElementById("wrongStat");
  const accStat = document.getElementById("accStat");
  const answeredStat = document.getElementById("answeredStat");
  const wrongList = document.getElementById("wrongList");
  const wrongCountBadge = document.getElementById("wrongCountBadge");

  const toast = document.getElementById("toast");
  const toastTxt = document.getElementById("toastTxt");

  // ===== Helpers =====
  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
  }
  function pct(n,d){ return d===0 ? 0 : Math.round((n/d)*100); }

  function setToast(msg, good=true){
    toastTxt.textContent = msg;
    const b = toast.querySelector(".b");
    b.style.background = good ? "var(--accent2)" : "var(--bad)";
    b.style.boxShadow = good ? "0 0 0 3px rgba(34,197,94,.18)" : "0 0 0 3px rgba(251,113,133,.18)";
    toast.classList.add("show");
    setTimeout(()=>toast.classList.remove("show"), 900);
  }

  // ===== Sound =====
  let audioCtx = null;
  function ensureAudio(){
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if(audioCtx.state === "suspended") audioCtx.resume();
    return audioCtx;
  }
  function beep(type="ok"){
    const ctx = ensureAudio();
    const now = ctx.currentTime;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "sine";

    let f1=660, f2=880, dur=0.12;
    if(type==="bad"){ f1=220; f2=165; dur=0.14; }
    if(type==="time"){ f1=330; f2=220; dur=0.16; }

    o.frequency.setValueAtTime(f1, now);
    o.frequency.exponentialRampToValueAtTime(Math.max(50,f2), now + dur);

    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(0.18, now + 0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, now + dur);

    o.connect(g); g.connect(ctx.destination);
    o.start(now);
    o.stop(now + dur + 0.02);
  }

  // ===== Stats UI =====
  function updateStats(){
    scorePill.textContent = score;
    correctStat.textContent = correct;
    wrongStat.textContent = wrong;
    answeredStat.textContent = answered;
    accStat.innerHTML = `${pct(correct, answered)}<small>%</small>`;
    wrongCountBadge.textContent = `${wrongLog.length} wrong`;
  }
  function renderWrongLog(){
    wrongList.innerHTML = "";
    if(wrongLog.length === 0){
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `<span class="tag">clean</span><div class="txt">No wrong answers yet. <em>Try not to choke üíÄ</em></div>`;
      wrongList.appendChild(div);
      return;
    }
    wrongLog.slice().reverse().forEach(w => {
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <span class="tag">${w.topic}</span>
        <div class="txt">
          ${w.q}
          <em>${w.timed ? "‚è± Time's up" : "You picked: <b>"+w.picked+"</b>"} ¬∑ Correct: <b>${w.correct}</b></em>
        </div>
      `;
      wrongList.appendChild(div);
    });
  }

  // ===== Timer bar animation =====
  function stopTimer(){
    if(raf) cancelAnimationFrame(raf);
    raf = null;
  }
  function startTimer(){
    stopTimer();
    timerWrap.style.display = "block";
    timerHint.style.display = "flex";

    timerBar.style.transform = "scaleX(1)";
    timerWrap.style.borderColor = "rgba(251,191,36,.45)";

    tStart = performance.now();
    tEnd = tStart + TIME_MS;

    const tick = (now) => {
      if(locked) return; // stop updating while locked
      const remaining = Math.max(0, tEnd - now);
      const p = remaining / TIME_MS; // 1 -> 0

      timerBar.style.transform = `scaleX(${p})`;

      // border turns red near end
      if(remaining <= 3500){
        timerWrap.style.borderColor = "rgba(251,113,133,.55)";
      }

      if(remaining <= 0){
        stopTimer();
        timeUp();
        return;
      }
      raf = requestAnimationFrame(tick);
    };
    raf = requestAnimationFrame(tick);
  }

  function timeUp(){
    if(locked) return;
    beep("time");
    choose(-1, true); // timeout = wrong
  }

  // ===== Quiz flow =====
  function loadQuestion(){
    if(idx >= pool.length){
      showEnd();
      return;
    }

    const q = pool[idx];
    locked = false;

    qNumEl.textContent = (idx + 1);
    qDiffEl.textContent = q.diff;
    streakEl.textContent = streak;

    const progress = (idx / pool.length);
    barEl.style.width = `${Math.max(6, Math.round(progress * 100))}%`;

    questionTextEl.textContent = q.q;
    questionSubEl.textContent = `Topic: ${q.topic} ¬∑ One correct answer.`;

    choicesEl.innerHTML = "";
    const letters = ["A","B","C","D"];
    q.choices.forEach((txt, i) => {
      const b = document.createElement("button");
      b.className = "btn";
      b.innerHTML = `<span class="key">${letters[i]}</span><div class="choiceText">${txt}</div>`;
      b.addEventListener("click", () => choose(i, false));
      choicesEl.appendChild(b);
    });

    feedbackEl.classList.remove("show");
    startTimer();
  }

  function choose(i, timedOut=false){
    if(locked) return;
    locked = true;
    stopTimer();

    const q = pool[idx];
    const buttons = [...choicesEl.querySelectorAll(".btn")];
    buttons.forEach(b => b.disabled = true);

    const correctIndex = q.a;
    const isCorrect = (!timedOut && i === correctIndex);

    // always highlight correct
    buttons[correctIndex]?.classList.add("good");
    if(!isCorrect && !timedOut && i >= 0 && buttons[i]) buttons[i].classList.add("bad");

    answered++;

    if(isCorrect){
      correct++;
      streak++;
      const bonus = Math.min(5, streak);
      const diffBoost = q.diff === "Hard" ? 3 : q.diff === "Medium" ? 2 : 1;
      score += (10 * diffBoost) + bonus;
      beep("ok");
      setToast(`Correct! +${(10*diffBoost)+bonus}`, true);

      resultBadgeEl.className = "badge good";
      resultBadgeEl.textContent = "‚úÖ Correct";
      explainEl.textContent = "Nice. Keep going.";
    } else {
      wrong++;
      streak = 0;
      score = Math.max(0, score - 3);

      wrongLog.push({
        topic: q.topic,
        q: q.q,
        picked: timedOut ? "(timeout)" : q.choices[i],
        correct: q.choices[correctIndex],
        timed: timedOut
      });

      beep(timedOut ? "time" : "bad");
      setToast(timedOut ? "Time's up üò≠ -3" : "Wrong üò≠ -3", false);

      resultBadgeEl.className = "badge " + (timedOut ? "warn" : "bad");
      resultBadgeEl.textContent = timedOut ? "‚è± Time's up" : "‚ùå Wrong";

      // brief explanation when wrong (your request)
      explainEl.textContent = q.explain || "Brief: the correct idea is in the highlighted answer.";
    }

    answerBadgeEl.className = "badge";
    answerBadgeEl.textContent = `Answer: ${["A","B","C","D"][correctIndex]}`;

    updateStats();
    renderWrongLog();

    feedbackEl.classList.add("show");

    // auto-next after short delay
    setTimeout(() => {
      idx++;
      updateProgressBar();
      if(idx < pool.length) {
        loadQuestion();
      } else {
        showEnd();
      }
    }, 1200);
  }

  function updateProgressBar(){
    const progress = Math.min(1, idx / pool.length);
    barEl.style.width = `${Math.round(progress * 100)}%`;
  }

  function showEnd(){
    stopTimer();
    locked = true;

    timerWrap.style.display = "none";
    timerHint.style.display = "none";

    choicesEl.innerHTML = "";
    questionTextEl.textContent = "Run finished üëë";
    questionSubEl.textContent = `Final Score: ${score} ¬∑ Accuracy: ${pct(correct, answered)}% ¬∑ Correct: ${correct} ¬∑ Wrong: ${wrong}`;
    barEl.style.width = "100%";

    feedbackEl.classList.add("show");
    resultBadgeEl.className = "badge good";
    resultBadgeEl.textContent = "üèÅ Done";
    answerBadgeEl.className = "badge";
    answerBadgeEl.textContent = "15s bar timer";

    explainEl.textContent = wrongLog.length
      ? "Check your wrong log on the right and run it again for revenge."
      : "Zero wrong? ok flex üò§";
  }

  // ===== Export results card =====
  function exportResultCard(){
    const W = 1080, H = 1350;
    const canvas = document.createElement("canvas");
    canvas.width = W; canvas.height = H;
    const ctx = canvas.getContext("2d");

    const grad = ctx.createLinearGradient(0,0,W,H);
    grad.addColorStop(0, "#0b0b0f");
    grad.addColorStop(0.45, "#14141b");
    grad.addColorStop(1, "#0b0b0f");
    ctx.fillStyle = grad;
    ctx.fillRect(0,0,W,H);

    function blob(x,y,r, color){
      const g = ctx.createRadialGradient(x,y,0, x,y,r);
      g.addColorStop(0, color);
      g.addColorStop(1, "rgba(0,0,0,0)");
      ctx.fillStyle = g;
      ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
    }
    blob(220, 200, 420, "rgba(124,58,237,.28)");
    blob(900, 160, 360, "rgba(34,197,94,.20)");
    blob(650, 1200, 520, "rgba(251,191,36,.12)");

    const pad = 70;
    const x = pad, y = pad, w = W - pad*2, h = H - pad*2;

    roundRect(ctx, x, y, w, h, 42);
    ctx.fillStyle = "rgba(255,255,255,.04)";
    ctx.fill();
    ctx.lineWidth = 3;
    ctx.strokeStyle = "rgba(255,255,255,.10)";
    ctx.stroke();

    ctx.fillStyle = "#f5f5ff";
    ctx.font = "900 54px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.fillText("STS Trivia Results", x + 56, y + 105);

    ctx.fillStyle = "rgba(185,185,214,.95)";
    ctx.font = "700 28px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace";
    const stamp = new Date().toLocaleString();
    ctx.fillText(`Timer: 15s  ‚Ä¢  ${stamp}`, x + 56, y + 155);

    ctx.fillStyle = "#ffffff";
    ctx.font = "900 140px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.fillText(`${score}`, x + 56, y + 320);

    ctx.fillStyle = "rgba(185,185,214,.95)";
    ctx.font = "800 30px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.fillText("SCORE", x + 60, y + 360);

    const boxY = y + 430;
    const gap = 22;
    const boxW = (w - 56*2 - gap) / 2;
    const boxH = 150;

    statBox(x + 56, boxY, boxW, boxH, "Accuracy", `${pct(correct, answered)}%`, "rgba(34,197,94,.18)");
    statBox(x + 56 + boxW + gap, boxY, boxW, boxH, "Answered", `${answered}`, "rgba(124,58,237,.18)");
    statBox(x + 56, boxY + boxH + gap, boxW, boxH, "Correct", `${correct}`, "rgba(74,222,128,.18)");
    statBox(x + 56 + boxW + gap, boxY + boxH + gap, boxW, boxH, "Wrong", `${wrong}`, "rgba(251,113,133,.18)");

    ctx.fillStyle = "rgba(245,245,255,.95)";
    ctx.font = "900 34px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.fillText("Latest mistakes", x + 56, boxY + boxH*2 + gap*2 + 155);

    ctx.fillStyle = "rgba(185,185,214,.95)";
    ctx.font = "700 26px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    const topWrong = wrongLog.slice().reverse().slice(0,5);
    let yy = boxY + boxH*2 + gap*2 + 205;
    if(topWrong.length === 0){
      ctx.fillText("None. You cooked.", x + 56, yy);
    } else {
      topWrong.forEach((w, i) => {
        ctx.fillText(`${i+1}. ${truncate(w.q, 62)}`, x + 56, yy);
        yy += 44;
      });
    }

    ctx.fillStyle = "rgba(185,185,214,.70)";
    ctx.font = "600 22px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace";
    ctx.fillText("Made from your STS slides ‚Ä¢ Trivia results card", x + 56, y + h - 60);

    const a = document.createElement("a");
    a.download = `sts_trivia_results_${Date.now()}.png`;
    a.href = canvas.toDataURL("image/png");
    a.click();

    setToast("Exported ‚úÖ", true);

    function roundRect(c, x, y, w, h, r){
      c.beginPath();
      c.moveTo(x+r, y);
      c.arcTo(x+w, y, x+w, y+h, r);
      c.arcTo(x+w, y+h, x, y+h, r);
      c.arcTo(x, y+h, x, y, r);
      c.arcTo(x, y, x+w, y, r);
      c.closePath();
    }
    function statBox(x,y,w,h,label,value, glow){
      roundRect(ctx, x, y, w, h, 28);
      ctx.fillStyle = "rgba(255,255,255,.03)";
      ctx.fill();
      ctx.lineWidth = 2;
      ctx.strokeStyle = "rgba(255,255,255,.10)";
      ctx.stroke();

      const g = ctx.createRadialGradient(x+w*0.25, y+h*0.35, 0, x+w*0.25, y+h*0.35, Math.max(w,h));
      g.addColorStop(0, glow);
      g.addColorStop(1, "rgba(0,0,0,0)");
      ctx.fillStyle = g;
      ctx.fillRect(x, y, w, h);

      ctx.fillStyle = "rgba(185,185,214,.95)";
      ctx.font = "800 26px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText(label, x+26, y+48);

      ctx.fillStyle = "#ffffff";
      ctx.font = "900 64px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText(value, x+26, y+115);
    }
    function truncate(s, n){ return s.length > n ? s.slice(0, n-1) + "‚Ä¶" : s; }
  }

  // Keyboard answers
  window.addEventListener("keydown", (e) => {
    const k = e.key.toUpperCase();
    const map = {A:0,B:1,C:2,D:3};
    if(map[k] !== undefined){
      const btns = choicesEl.querySelectorAll(".btn");
      if(btns[map[k]]) btns[map[k]].click();
    }
  });

  // Start
  startBtn.addEventListener("click", () => {
    // unlock audio on user gesture
    ensureAudio();
    startControlsEl.style.display = "none";
    timerWrap.style.display = "block";
    timerHint.style.display = "flex";
    setToast("Go.", true);
    loadQuestion();
  });

  exportBtn.addEventListener("click", exportResultCard);

  // Init
  function init(){
    modeLabel.textContent = "Mixed";
    pool = shuffle(QUESTIONS.slice());
    qTotalEl.textContent = pool.length;
    updateStats();
    renderWrongLog();
  }
  init();
})();
</script>
</body>
</html>
